---
title: Основы MongoDB и Mongoose
data: 08-01-2020
---

## Введение в MongoDB и Mongoose

**MongoDB** - это база данных, которая хранит записи данных (документы) для использования приложением. Mongo - это нереляционная база данных "NoSQL". Это означает, что Mongo хранит все связанные данные в одной записи, а не хранит их во многих заранее заданных таблицах, как в базе данных SQL. Некоторые преимущества этой модели хранения заключаются в следующем:

* Масштабируемость: по умолчанию нереляционные базы данных распределяются (или "совместно используются") на множество систем, а не только на одну. Это облегчает повышение производительности при меньших затратах.
* Гибкость: новые наборы данных и свойств могут быть добавлены в документ без необходимости создавать новую таблицу для этих данных.
* Репликация: копии базы данных выполняются параллельно, поэтому, если одна из них не работает, одна из копий становится новым основным источником данных.

Хотя существует много нереляционных баз данных, использование Mongo с JSON в качестве структуры хранения документов делает его логичным выбором при изучении бэкенда JavaScript. Доступ к документам и их свойствам подобен доступу к объектам в JavaScript.

**Mongoose.js** - это модуль npm для Node.js, который позволяет вам писать объекты для Mongo так же, как и в JavaScript. Это может облегчить создание документов для хранения в Mongo.

Для создания веб-приложений с помощью базы данных MongoDB вы можете использовать три пути:

1. Развернуть и настроить сервер базы данных MongoDB на своем локальном компьютере. Приложение Node, которое будет работать с базой данных MongoDB, вы тоже можете разрабатывать и запускать у себя на компьютере. Для этого на вашем компьютере должны быть установлены [сервер Node](https://nodejs.org/ru/download/package-manager/) и [сервер базы данных MongoDB](https://docs.mongodb.com/master/installation/).
2. Использовать облачный сервис MongoDB Atlas для создания базы данных MongoDB, а приложение разрабатывать и запускать на локальном ПК.
3. Использовать облачный сервис MongoDB Atlas для создания базы данных MongoDB, а приложение разрабатывать и запускать на каком-нибудь облачном сервисе, например [Glitch](https://glitch.com).

Здесь будет приведен самый трудный первый путь развертывания базы данных и разработки приложения.

## Установка и настройка Mongoose и MongoDB

Дальнейшие действия предполагают, что у вас нет своего проекта, и что вы начнете с нуля.

В терминале создайте каталог `myapp` и сделайте его рабочим.

```
md myapp
cd myapp
```

С помощью команды `npm init` создайте файл `package.json`. 

```
npm init
```

Эта команда выдает целый ряд приглашений, например, приглашение указать имя и версию вашего приложения. На данный момент, достаточно просто нажать клавишу ВВОД, чтобы принять предлагаемые значения по умолчанию для большинства пунктов, кроме следующего:

```
entry point: (index.js)
```

Введите app.js или любое другое имя главного файла по своему желанию. Если вас устраивает index.js, нажмите клавишу ВВОД, чтобы принять предложенное имя файла по умолчанию.

Чтобы ваше приложение могло работать с базой данных MongoDB нужно установить драйвер. Установите драйвер MongoDB и его зависимости, выполнив в терминале из каталога `myapp` следующую команду.

```
npm install mongodb
```

Теперь установите модуль mongoose в каталоге `myapp`, набрав следующую команду в терминале.

```
npm install mongoose
```

После установки в каталоге `myapp` будут находится два файла `package.json`, `package-lock.json` и каталог `node_modules`. В файле `package.json` будут добавлены зависимости:

```json
"dependencies": {
    "mongodb": "^3.4.1",
    "mongoose": "^5.8.7"
}
```
## Подключение БД MongoDB с помощью Mongoose

В корне проекта создайте файл `index.js`, в который скопируйте следующий код.

```js 
//Подключение к файлу модуля mongoose под именем mongoose
var mongoose = require('mongoose');
//Соединение с базой данных `test` на вашем локально запущенном экземпляре MongoDB.
mongoose.connect('mongodb://127.0.0.1:27017/test', {useNewUrlParser: true});
var db = mongoose.connection;
//Если при соединении с БД происходит ошибка выводится сообщение 'MongoDB connection error:'
db.on('error', console.error.bind(console, 'MongoDB connection error:'));
//Если соединение с БД выполнено успешно выполняется код в колбек-функции
db.once('open', function() {
  // we're connected!
});
```

Как только наше соединение откроется, будет вызван наш обратный вызов. Для краткости давайте предположим, что весь следующий код находится внутри этого обратного вызова.


## Создание модели

### CRUD Часть I - создание

CRUD - это сокращение для операций Create, Read, Update and Delete (создать, прочесть, обновить и удалить). Эти операции являются основными для работы с базами данных, таких как MongoDB.

В mongoose все завязано на 2х ключевых понятиях Схема(Schema) – описание сущности и Модель – сама сущность.
Прежде всего вам нужна [схема]https://mongoosejs.com/docs/guide.html. 

Создадайте схему для комментариев.

В корне проекта создайте файл `index.js`, в который скопируйте следующий код.

```js
//запрос модуля `mongoose` в файл под именем `mongoose`
const mongoose = require('mongoose');
//подключение к БД 
mongoose.connect(process.env.MONGO_URI); 

var UserSchema = new mongoose.Schema( {
    name: { type: String, default: "hahaha" },
    age: { type: Number, min: 18, index: true },
    bio: { type: String, match: /[a-z]/ },
    date: { type: Date },
    buff: Buffer
} );
```

Каждое поле характеризуется типом SchemaTypes и может иметь дополнительные характеристики: `default`, `min` и `max` (для Number), `match` и `enum` (для String), `index` и `unique` (для индексов).

Подробнее о типах можно почитать [тут](https://mongoosejs.com/docs/schematypes.html).


Каждая схема сопоставляется с коллекцией MongoDB. Она определяет форму документов внутри этой коллекции. Схемы - это строительный блок для моделей. Они могут быть вложенными для создания сложных моделей, но в этом случае мы будем держать вещи простыми. Модель позволяет создавать экземпляры ваших объектов, называемых документами.


```js
var mongoose = require('mongoose');
const Schema = mongoose.Schema;

const personSchema = new Schema({
  name: { type: String, required: true },
  age: Number,
  favoriteFoods: [String]
});

//Создание модели человека из схемы.
const Person = mongoose.model("Person", personSchema);
```

## Создание и сохранение записи модели


```js
/** 1) Установка и настройка mongoose */

const mongoose = require('mongoose');
mongoose.connect(process.env.MONGO_URI);

/** 2) Создание Модели 'Person' */
var personSchema = new mongoose.Schema({
  name: String,
  age: Number,
  favoriteFoods: [String]
});

/** 3) Создание и сохранение Person */
var Person = mongoose.model('Person', personSchema);

var createAndSavePerson = function(done) {
  var janeFonda = new Person({name: "Jane Fonda", age: 84, favoriteFoods: ["vodka", "air"]});

  janeFonda.save(function(err, data) {
    if (err) return console.error(err);
    done(null, data)
  });
};
```


MongoDB, как и MySQL, может содержать множество баз данных, но вместо таблиц базы данных MongoDB содержат “коллекции”.
Коллекция - это что-то типа таблицы, только без колонок. Вместо этого каждая строка содержит наборы записей в виде ключ:значение.


Найденые ресурсы

* http://www.coldfox.ru/article/5be022d49227d914a1c83fe3/%D0%9F%D0%BE%D0%B4%D1%80%D0%BE%D0%B1%D0%BD%D0%BE%D0%B5-%D1%80%D1%83%D0%BA%D0%BE%D0%B2%D0%BE%D0%B4%D1%81%D1%82%D0%B2%D0%BE-%D0%BF%D0%BE-MongoDB-Mongoose


Используемые ресурсы

* http://stepansuvorov.com/blog/2012/11/mongoose-%D0%B4%D0%BB%D1%8F-mongodb/

* https://developer.mozilla.org/ru/docs/Learn/Server-side/Express_Nodejs/mongoose