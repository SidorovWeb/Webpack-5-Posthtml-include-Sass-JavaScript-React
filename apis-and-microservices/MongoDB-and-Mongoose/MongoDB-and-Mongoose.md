---
title: Основы MongoDB и Mongoose
data: 08-01-2020
---

## Введение в MongoDB и Mongoose

**MongoDB** - это база данных, которая хранит записи данных (документы) для использования приложением. Mongo - это нереляционная база данных "NoSQL". Это означает, что Mongo хранит все связанные данные в одной записи, а не хранит их во многих заранее заданных таблицах, как в базе данных SQL. Некоторые преимущества этой модели хранения заключаются в следующем:

* Масштабируемость: по умолчанию нереляционные базы данных распределяются (или "совместно используются") на множество систем, а не только на одну. Это облегчает повышение производительности при меньших затратах.
* Гибкость: новые наборы данных и свойств могут быть добавлены в документ без необходимости создавать новую таблицу для этих данных.
* Репликация: копии базы данных выполняются параллельно, поэтому, если одна из них не работает, одна из копий становится новым основным источником данных.

Хотя существует много нереляционных баз данных, использование Mongo с JSON в качестве структуры хранения документов делает его логичным выбором при изучении бэкенда JavaScript. Доступ к документам и их свойствам подобен доступу к объектам в JavaScript.

**Mongoose.js** - это модуль npm для Node.js, который позволяет вам писать объекты для Mongo так же, как и в JavaScript. Это может облегчить создание документов для хранения в Mongo.

## Использование MongoDB Atlas для размещения бесплатного экземпляра mongodb для ваших проектов

Для решения нижеследующих задач вы будете использовать MongoDB для хранения наших данных. Для упрощения конфигурации будете использовать MongoDB Atlas.

MongoDB Atlas - это платформа MongoDB Database-as-a-Service, которая означает, что сервис настраивает и размещает базу данных для вас так, что единственной обязанностью для вас остается заполнение вашей базы нужными данными. Говоря другими словами, MongoDB Atlas должна снять с плечей клиентов основную нагрузку управления базами NoSQL, позволив им сфокусироваться на своих приложениях. Мы покажем вам, как это делается:

* Создание учетной записи в MongoDB Atlas.
* Создание нового кластера.
* Создание нового пользователя в базе данных.
* Белый список ваших IP-адресов.
* Подключение к своему кластеру.

### Создание учетной записи в MongoDB Atlas.

Давайте начнем с того, что [отправимся в MongoDB Atlas](https://www.mongodb.com/cloud/atlas).

Как только вы откроете страницу MongoDB Atlas, вам следует зарегистрироваться для получения новой учетной записи.

* Нажмите кнопку [Sign In](https://cloud.mongodb.com/user#/atlas/login) в правом верхнем углу, чтобы открыть страницу регистрации.
* Нажмите на ссылку [Register for a new account](https://cloud.mongodb.com/user#/atlas/register/accountProfile) в нижней части страницы входа.
* Заполните регистрационную форму своей информацией и нажмите кнопку `Continue`.
* Теперь вы должны войти в свой новый аккаунт и увидеть зеленую кнопку `Build a Cluster`, нажмите на нее.

### Создание нового кластера

* Выполните шаги по созданию первого кластера, следуя инструкциям, которые сайт предоставляет, и нажимая кнопку `Continue` после каждого шага.
  * Выберите поставщика облачных услуг и регион, вы можете оставить его в качестве предоставленного по умолчанию (обычно AWS).
  * Настройте спецификации вашего кластера, вы также можете оставить это как предоставленное по умолчанию, M0 Sandbox (Shared RAM, 512 MB Storage) зашифрованным.
  * Дайте вашему кластеру имя, вы также можете оставить его как предоставленное по умолчанию, Cluster0.
* Теперь нажмите зеленую кнопку `Create Cluster` в нижней части экрана и проверьте подписи к изображениям, которые они предоставляют.
* Теперь вы должны увидеть сообщение, Your cluster is being created - New clusters take between 7-10 minutes to provision (что означает, что ваш кластер создается - создание новых кластеров занимает от 7 до 10 минут). Прежде чем перейти к следующему шагу, дождитесь создания кластера.

### Создание нового пользователя в базе данных

Вы должны быть в состоянии увидеть зеленую кнопку `Get Started` в нижней левой части экрана. Вы можете нажать эту кнопку, чтобы увидеть, на каком этапе процесса вы находитесь, если вы нажмете на нее сейчас, вы можете увидеть следующий шаг, `Create your first database user`, идите вперед и нажмите на этот шаг.

* Следуйте инструкциям, нажав на вкладку `Security`.
* Нажмите на зеленую кнопку `ADD NEW USER`.
* Введите имя пользователя и пароль, а затем выберите `Read or write to any database` в разделе User Privileges, не забудьте сохранить свое имя пользователя и пароль в безопасном месте.
* Нажмите на зеленую кнопку `ADD USER` в правом нижнем углу модала.

Примечание: Вы всегда можете обновить свои привилегии до уровня администратора, однако лучше всего предоставлять разрешения пользователю по мере необходимости из соображений безопасности.

### Белый список ваших IP-адресов

* Если вы сейчас нажмете на зеленую кнопку `Get Started` в левом нижнем углу экрана, вы должны увидеть следующий шаг, чтобы сделать выделенный, `Whitelist your IP address`, нажмите на него.
  * Следуйте инструкциям, нажав на вкладку `IP Whitelist` под вкладкой `Security`.
  * Нажмите на зеленую кнопку `ADD IP ADDRESS`.
  * В модальном режиме нажмите кнопку `ALLOW ACCESS FROM ANYWHERE`, и вы увидите предварительно заполненное поле ввода белого списка 0.0.0.0/0, Нажмите зеленую кнопку `Confirm`.

### Подключение к кластеру

* Нажав на зеленую кнопку `Get Started` в левом нижнем углу экрана, должен показаться последний шаг, `Connect to your cluster`, нажмите на него.
  * Следуйте инструкциям, нажав на кнопку `Connect` в разделе `Sandbox`.
  * Во всплывающем режиме нажмите кнопку `Connect Your Application`, появится строка подключения, вы можете скопировать эту строку подключения, нажав на кнопку `Copy`.
  * Это будет последний URI, который вы будете использовать для подключения к вашей БД, он будет выглядеть примерно так `mongodb+srv://<user>:<password>@<cluster#-dbname>.mongodb.net/test?retryWrites=true`, обратите внимание, что поля user и cluster#-dbname уже заполнены для вас, все, что вам нужно будет заменить - это поле пароля на то, которое вы создали на предыдущем шаге.
* Вот и все! Теперь у вас есть URI, который вы добавите в свое приложение для подключения к базе данных. Храните этот URI в надежном месте, чтобы вы могли использовать его позже!
* Не стесняйтесь создавать отдельные базы данных для разных приложений, если им нужна отдельная база данных. Вам просто нужно создать новый проект под вашей текущей учетной записью MongoDB Atlas, построить новый кластер, добавить нового пользователя, белый список ваших IP-адресов и, наконец, подключиться к кластеру, чтобы получить новый URI.

`mongodb+srv://injashkin:<password>@cluster0-hsvns.mongodb.net/test?retryWrites=true&w=majority`

## Установка и настройка Mongoose

Чтобы продолжать изучение нижеследующих материалов, на вашем компьютере должны быть установлены сервер Node и сервер базы данных MongoDB. Самую актуальную информацию о установке MongoDB на ваш ПК можно прочитать на [официальном сайте](https://docs.mongodb.com/master/installation/)

Дальнейшие действия предполагают, что у вас нет своего проекта, и что вы начнете с нуля.

В терминале создайте каталог `myapp` и сделайте его рабочим.

```
md myapp
cd myapp
```

С помощью команды `npm init` создайте файл `package.json`. 

```
npm init
```

Эта команда выдает целый ряд приглашений, например, приглашение указать имя и версию вашего приложения. На данный момент, достаточно просто нажать клавишу ВВОД, чтобы принять предлагаемые значения по умолчанию для большинства пунктов, кроме следующего:

```
entry point: (index.js)
```

Введите app.js или любое другое имя главного файла по своему желанию. Если вас устраивает index.js, нажмите клавишу ВВОД, чтобы принять предложенное имя файла по умолчанию.

Чтобы ваше приложение могло работать с базой данных нужно установить драйвер. Установите драйвер MongoDB и его зависимости, выполнив в терминале из каталога `myapp` следующую команду.

```
npm install mongodb
```

Теперь установите mongoose в каталоге `myapp`, набрав следующую команду в терминале.

```
npm install mongoose
```

После установки в каталоге `myapp` будут находится два файла `package.json`, `package-lock.json` и каталог `node_modules`. В файле `package.json` будут добавлены зависимости:

```json
"dependencies": {
    "mongodb": "^3.4.1",
    "mongoose": "^5.8.6"
}
```

В корне проекта создайте приватнй файл `.env`. Сохраните в этом файле URI базы данных MongoDB Atlas, полученный раннее:

```
MONGO_URI='mongodb+srv://<user>:<password>@cluster0-hsvns.mongodb.net/test?retryWrites=true&w=majority'
```

Обратите внимание: URI окружен одинарными (можно двойными) кавычками; между переменной MONGO_URI и знаком `=`, а также, между знаком `=` и URI не должно быть пробела; замените <user> на имя пользователя, а <password> на свой пароль в MongoDB Atlas. Там не должно быть символов <> (если только они не находятся в вашем пароле).

В корне проекта создайте файл `index.js`, в который скопируйте следующий код.

```js
const mongoose = require('mongoose');
mongoose.connect(process.env.MONGO_URI);
```

Данный код подключает базу данных к приложению.

## Создание модели

### CRUD Часть I - создание

Приложения могут использовать различные базы данных, и есть несколько подходов, которые можно использовать для выполнения операций **C**reate, **R**ead, **U**pdate and **D**elete (CRUD) (создать, прочесть, обновить, удалить).

В mongoose все завязано на 2х ключевых понятиях Схема(Schema) – писание сущности и Модель – сама сущность.
Прежде всего вам нужна [схема]https://mongoosejs.com/docs/guide.html. 

Создадайте схему для комментариев. Для этого в файл `index.js` скопируйте следующее:

```js
const mongoose = require('mongoose');
mongoose.connect(process.env.MONGO_URI); 

var UserSchema = new mongoose.Schema( {
    name: { type: String, default: "hahaha" },
    age: { type: Number, min: 18, index: true },
    bio: { type: String, match: /[a-z]/ },
    date: { type: Date },
    buff: Buffer
} );
```

Каждое поле характеризуется типом SchemaTypes и может иметь дополнительные характеристики: `default`, `min` и `max` (для Number), `match` и `enum` (для String), `index` и `unique` (для индексов).

Подробнее о типах можно почитать [тут](https://mongoosejs.com/docs/schematypes.html).


Каждая схема сопоставляется с коллекцией MongoDB. Она определяет форму документов внутри этой коллекции. Схемы - это строительный блок для моделей. Они могут быть вложенными для создания сложных моделей, но в этом случае мы будем держать вещи простыми. Модель позволяет создавать экземпляры ваших объектов, называемых документами.






Glitch - это реальный сервер, а на реальных серверах взаимодействие с БД происходит в функциях обработчиков. Эти функции выполняются, когда происходит какое-то событие (например, кто-то попадает в конечную точку на вашем API). Мы будем следовать тому же подходу в этих упражнениях. Функция `done()` - это колбэк, который говорит нам, что мы можем продолжить работу после завершения асинхронной операции, такой как вставка, поиск, обновление или удаление. Он следует условию Node и должен вызываться как `done(null, data)` при успешном выполнении или `done(err)` при ошибке. Предупреждение - при взаимодействии с удаленными службами могут возникать ошибки!

```js
var someFunc = function(done) {
  //... сделай что-нибудь (рискни) ...
  if(error) return done(error);
  done(null, result);
};
```

Создайте человека, имеющего этот прототип 

```
- Person Prototype -
--------------------
name : string [required]
age : number
favoriteFoods : array of strings (*)
```

Используйте основные типы схем mongoose. Если вы хотите, вы также можете добавить дополнительные поля, использовать простые валидаторы, такие как обязательные или уникальные, и установить значения по умолчанию. Смотрите документы [mongoose](http://mongoosejs.com/docs/guide.html).

```js
var mongoose = require('mongoose');
const Schema = mongoose.Schema;

const personSchema = new Schema({
  name: { type: String, required: true },
  age: Number,
  favoriteFoods: [String]
});

//Создание модели человека из схемы.
const Person = mongoose.model("Person", personSchema);
```




MongoDB, как и MySQL, может содержать множество баз данных, но вместо таблиц базы данных MongoDB содержат “коллекции”.
Коллекция - это что-то типа таблицы, только без колонок. Вместо этого каждая строка содержит наборы записей в виде ключ:значение.


Найденые ресурсы

* http://www.coldfox.ru/article/5be022d49227d914a1c83fe3/%D0%9F%D0%BE%D0%B4%D1%80%D0%BE%D0%B1%D0%BD%D0%BE%D0%B5-%D1%80%D1%83%D0%BA%D0%BE%D0%B2%D0%BE%D0%B4%D1%81%D1%82%D0%B2%D0%BE-%D0%BF%D0%BE-MongoDB-Mongoose


Используемые ресурсы

* http://stepansuvorov.com/blog/2012/11/mongoose-%D0%B4%D0%BB%D1%8F-mongodb/

* https://developer.mozilla.org/ru/docs/Learn/Server-side/Express_Nodejs/mongoose